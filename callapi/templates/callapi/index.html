{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>RunningX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://apis.openapi.sk.com/tmap/vectorjs?version=1&appKey=OF93Av1S5v2pHZvLIqzpUaq7OYEpaKFKa9yKt0NF"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f7f7f7;
      overflow-x: hidden;
    }

    /* 애니메이션 */
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeLeft {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(-80px); }
    }

    /* 상단 */
    .top-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      animation: fadeInDown 1s ease forwards;
      animation-delay: 0.2s;
      opacity: 0;
    }

    .top-section img {
      width: 180px;
      height: auto;
      animation: fadeInDown 1s ease forwards;
      animation-delay: 0.1s;
      opacity: 0;
    }

    h2 {
      margin: 0 0 10px;
      font-size: 20px;
      text-align: center;
      animation: fadeInDown 1s ease forwards;
      animation-delay: 0.3s;
      opacity: 0;
    }

    #map_div {
      width: 100%;
      height: 500px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .06);
      animation: fadeInDown 1s ease forwards;
      animation-delay: 0.4s;
      opacity: 0;
    }

    /* 폼 */
    form {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
      gap: 12px 16px;
      align-items: center;
      animation: fadeInUp 1s ease forwards;
      animation-delay: 0.6s;
      opacity: 0;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
      color: #111827;
    }

    input[type="text"] {
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      background: white;
      width: 100%;
      box-sizing: border-box;
    }

    .row {
      grid-column: 1 / -1;
    }

    .actions {
      grid-column: 1 / -1;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 6px;
    }

    button {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: white;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
      transition: background 0.2s;
    }

    button:hover {
      background: #f9fafb;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
    }

    /* ✅ 모바일 최적화 */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .top-section img {
        width: 140px;
      }

      h2 {
        font-size: 17px;
        margin-bottom: 6px;
      }

      #map_div {
        height: 320px;
      }

      form {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      label {
        font-size: 15px;
      }

      input[type="text"] {
        font-size: 15px;
        padding: 12px;
      }

      button {
        flex: 1;
        font-size: 16px;
        padding: 12px;
      }

      .hint {
        font-size: 13px;
        flex-basis: 100%;
      }
    }

    /* ✅ 초소형 기기 */
    @media (max-width: 400px) {
      .top-section img {
        width: 120px;
      }

      h2 {
        font-size: 15px;
      }

      input[type="text"] {
        font-size: 14px;
        padding: 10px;
      }

      button {
        font-size: 14px;
        padding: 10px;
      }

      #map_div {
        height: 250px;
      }
    }

    /* ✅ 페이드아웃 클래스 */
    .fade-left {
      animation: fadeLeft 0.8s ease forwards;
    }

    /* ✅ 처리중 텍스트 */
    #loadingText {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: 600;
      color: #6b7280;
    }
  </style>
</head>

<body onload="initTmap()">
  <div id="pageContent">
    <div class="top-section">
      <img src="{% static 'main/images/catch.png' %}" alt="Catch Image">
      <h2>지도를 클릭해 위치를 선택하세요</h2>
      <div id="map_div"></div>
    </div>

    <form method="POST">
      {% csrf_token %}
      <label class="row">
        주소
        <input type="text" name="address" id="addressInput" readonly placeholder="지도에서 위치를 클릭하면 자동으로 채워집니다">
      </label>
      <label>
        위도
        <input type="text" name="lat" id="latInput" readonly placeholder="예: 37.566500">
      </label>
      <label>
        경도
        <input type="text" name="lon" id="lonInput" readonly placeholder="예: 126.978000">
      </label>
      <label>
        거리 (m)
        <input type="text" name="distance" value="{{ default_distance }}">
      </label>
      <label>
        Cycle
        <input type="text" name="cycle" value="{{ default_cycle }}">
      </label>
      <label>
        몸무게 (kg)
        <input type="text" name="weight_kg" value="{{ default_weight }}">
      </label>
      <div class="actions">
        <label style="display:flex; align-items:center; gap:8px; margin:0;">
          <input type="checkbox" name="facility" value="yes"> 편의시설 포함 여부
        </label>
        <button type="submit">제출</button>
        <span class="hint">지도를 클릭하면 위도/경도/주소가 자동으로 입력됩니다.</span>
      </div>
    </form>
  </div>

  <div id="loadingText">처리중.</div>

  <script>
    let map = null;
    let marker = null;

    function initTmap() {
      map = new Tmapv3.Map("map_div", {
        center: new Tmapv3.LatLng(37.5665, 126.9780),
        width: "100%",
        height: "500px",
        zoom: 16
      });

      map.on("ConfigLoad", () => {
        const handler = (evt) => {
          const ll = evt?.fi?.lngLat || evt?.lngLat || evt?.latLng;
          const lat = ll?._lat ?? ll?.lat;
          const lon = ll?._lng ?? ll?.lng;

          if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

          if (marker) marker.setMap(null);
          marker = new Tmapv3.Marker({
            position: new Tmapv3.LatLng(lat, lon),
            map: map
          });

          document.getElementById("latInput").value = Number(lat).toFixed(6);
          document.getElementById("lonInput").value = Number(lon).toFixed(6);

          const url = `https://apis.openapi.sk.com/tmap/geo/reversegeocoding?version=1&format=json&coordType=WGS84GEO&addressType=A10&lon=${lon}&lat=${lat}&appKey=OF93Av1S5v2pHZvLIqzpUaq7OYEpaKFKa9yKt0NF`;

          fetch(url)
            .then(res => res.json())
            .then(data => {
              const address = data?.addressInfo?.fullAddress || "주소 정보를 불러오지 못했습니다";
              document.getElementById("addressInput").value = address;
            })
            .catch(() => {
              document.getElementById("addressInput").value = "주소 요청 실패";
            });
        };

        map.on("Click", handler);
        map.on("click", handler);
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const here = new Tmapv3.LatLng(lat, lon);
            map.setCenter(here);
            new Tmapv3.Marker({ position: here, map: map, title: "현재 위치" });
          },
          () => console.warn("위치 정보를 가져올 수 없습니다."),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }

      // ✅ 제출 버튼 클릭 시 애니메이션 추가
      const form = document.querySelector("form");
      form.addEventListener("submit", (e) => {
        const pageContent = document.getElementById("pageContent");
        const loading = document.getElementById("loadingText");

        // 요소들 왼쪽으로 페이드아웃
        pageContent.classList.add("fade-left");

        // 페이드아웃 후 처리중 표시
        setTimeout(() => {
          pageContent.style.display = "none";
          loading.style.display = "block";

          // 점 개수 순환 애니메이션
          let dots = 1;
          setInterval(() => {
            dots = (dots % 3) + 1;
            loading.textContent = "처리중" + ".".repeat(dots);
          }, 500);
        }, 800);
      });
    }
  </script>
</body>
</html>


